rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Caretaker-patient linking collection
    match /caretakerPatients/{caretakerUid} {
      // Caretakers can only access their own linking documents
      allow read, write: if request.auth != null && request.auth.uid == caretakerUid;
      
      match /linkedPatients/{patientId} {
        allow read, write: if request.auth != null && request.auth.uid == caretakerUid;
      }
    }
    
    // Patient document rules - consolidated to avoid conflicts
    match /patients/{patientId} {
      // Allow patients to read/write their own document
      // OR allow caretakers to read/write if they are linked to this patient
      allow read, write: if request.auth != null && (
        // Patient can access their own document
        request.auth.uid == patientId ||
        // OR caretaker can access if they are linked to this patient
        exists(/databases/$(database)/documents/caretakerPatients/$(request.auth.uid)/linkedPatients/$(patientId))
      );
      
      // Allow access to subcollections with same rules
      match /{subcollection}/{document=**} {
        allow read, write: if request.auth != null && (
          // Patient can access their own subcollections
          request.auth.uid == patientId ||
          // OR caretaker can access if they are linked to this patient
          exists(/databases/$(database)/documents/caretakerPatients/$(request.auth.uid)/linkedPatients/$(patientId))
        );
      }
    }
    
    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
